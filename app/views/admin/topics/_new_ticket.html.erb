<div>
<%= content_tag :h3, "#{t(:open_new_discussion, default: 'New Ticket')}", class: 'view-header' %>
<%= simple_form_for(@topic, url: admin_topics_path, remote: true, validate: true, multipart: true, authenticity_token: true, html: { class: 'form-vertical new-ticket-loader', method: 'post' }) do |f| -%>
<div class="row">
  <div class="col-md-8">

    <%= f.input :kind, collection: [["Customer Conversation", 'ticket'],["Internal Ticket", 'internal']], class: 'disable-empty', autofocus: true, include_blank: false, label: "Type of Ticket" -%>
    <%= f.input :name, :size => 40, class: 'disable-empty', autofocus: true -%>

    <%= f.simple_fields_for @user do |u| %>
      <%= u.input :name, class: 'disable-empty' %>
      <%= u.input :home_phone, class: 'disable-empty', label: "Phone" %>
      <%= content_tag(:div, '', class: 'fa fa-angle-down pull-right cc-bcc-toggle', role: 'button') %>

      <%= u.input :email, class: 'disable-empty', label: "Email (#{link_to 'generate temporary', '#', class: 'generate-temp'})".html_safe %>
    <% end %>
  <%= f.simple_fields_for @topic.posts.new do |i| %>
    <%#= i.input :body, input_html: { rows: 8, cols: 60, class: 'disable-empty form-control' }, label: false, validate: { presence: true } -%>

    <span class="cc-bcc hidden">
    <%= i.input :cc, label: false, placeholder: 'cc:' %>
    <%= i.input :bcc, label: false, placeholder: 'bcc:' %>
    </span>
    <%= i.input :body, as: :summernote, label: false, class: 'disable-empty' %>

    <% if !cloudinary_enabled? %>
      <%= i.file_field :attachments, multiple: true %>
      <ul class="list-inline" id="attachments">
      </ul>
    <% end %>
    <%= hidden_field_tag :client_id %>
    <div class="add-screenshots">
      <%= attachinary_file_field_tag 'topic[screenshots]', @topic, :screenshots if cloudinary_enabled? %>
    </div>
  <% end %>
    <%= f.button :submit, t(:submit_start_discussion, default: 'Start Discussion'), class: 'btn btn-warning disableable' %>
  </div>
  <div class="col-md-4">
    <%= f.input :channel, collection: [[t('activerecord.attributes.user.email'), 'email'],[t('activerecord.attributes.user.home_phone'), 'phone'],[t(:channel_in_person, default: 'In Person'), 'person']], as: :select, include_blank: false, item_wrapper_class: 'channel-item', item_wrapper_tag: :div, class: 'channel-toggle' %>
    <% if teams = admin_teams %>
      <%= f.input(:team_list, collection: teams, :label => t(:assign_to), locale: I18n.locale, prompt: "", style: "display:none;") if teams? and teams.count > 0 %>
    <% end %>
    <%= f.input :priority, collection: Topic.priorities.keys.map { |priority| [priority.titleize, priority] } , as: :select, include_blank: true, selected: 'normal' %>
    <%= f.input :current_status, collection: statuses_for_select, as: :select, include_blank: false, selected: 'new' %>
    <%= f.input :assigned_user_id, collection: agents_for_select, as: :select, include_blank: true, selected: current_user.id %>
    <%= f.input :tag_list %>

  </div>
</div>
<% end -%>
</div>

<script>
$('[data-provider="summernote"]').each(function(){
  $(this).summernote({
    height: 150,
    prettifyHtml: true,
    toolbar: [
      ['style', ['bold', 'italic', 'underline', 'clear']]
    ],
    codemirror: {
      theme: 'monokai',
      mode: "htmlmixed",
      tabsize: 2,
      smartIndent: true,
      lineNumbers: true,
      lineWrapping: true,
      tabMode: 'indent'
    },
    hint: {
      match: /:([\-+\w]+)$/,
      search: function (keyword, callback) {
        callback($.grep(emojis, function (item) {
          return item.indexOf(keyword)  === 0;
        }));
      },
      template: function (item) {
        var content = emojiUrls[item];
        return '<img src="' + content + '" width="20" /> :' + item + ':';
      },
      content: function (item) {
        var url = emojiUrls[item];
        if (url) {
          return $('<img />').attr('src', url).css('width', 20)[0];
        }
        return '';
      }
    }
  });
});
$.ajax({
  url: 'https://api.github.com/emojis',
  async: false
}).then(function(data) {
  window.emojis = Object.keys(data);
  window.emojiUrls = data;
});
</script>
