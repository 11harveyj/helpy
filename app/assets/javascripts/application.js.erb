// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or any plugin's vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require twitter/bootstrap
//= require turbolinks
//= require jquery.turbolinks
//= require_tree .
//= require twitter/bootstrap/rails/confirm
//= require bootstrap-icon-chooser/js/iconPicker
//= require rails-timeago-all
//= require quill/dist/quill
//= require flare/dist/flare

var Helpy = Helpy || {};

Helpy.ready = function(){

  $('.thumbnail, .stats').off();

  // jquery hhoks for the home page
  $('.home-option, .home-option-xs, .topic-box').click(function(){
    document.location.href = $(this).data("link");
  });

  $('.thumbnail, .stats').on('mouseover',function(){
    $(this).css('cursor','pointer');
    $(this).css('border','1px solid #666');
    $(this).css('box-shadow', '0px 0px 10px #eee');
    $(this).closest('.has-arrow').addClass('over');
  });


  $('.stats').on('click', function(){


    $('.stats').css('border','1px solid #ddd');
    $('.stats').css('box-shadow', '');
    $('.has-arrow').removeClass("over");
    $('.stats').removeClass("selected");

    $(this).addClass('selected');
    $(this).css('border','1px solid #666');
    $(this).css('box-shadow', '0px 0px 10px #eee');
    $(this).closest('.has-arrow').addClass('over');

    var form = $("<form></form>");
    form.attr(
    {
        id     : "formform",
        // The location given in the link itself
        action : $(this).find('a').attr('href'),
        method : "GET",
        "data-remote" : "true"
    });

    $("body").append(form);
    $("#formform").submit();
    $("#formform").remove();

    // Prevent the link from opening normally
    return false;
  });

  $('.thumbnail, .stats').on('mouseout',function(){
    if ($(this).hasClass('selected') !== true) {
      $(this).css('cursor','auto');
      $(this).css('border','1px solid #ddd');
      $(this).css('box-shadow', '');
      $(this).closest('.has-arrow').removeClass('over');
    }
  });



  // Sets up autoscroll for any link with class autoscroll
  // requires data-target param containing class or ID of target
  $(".autoscroll").each(function(){
      $(this).click(function(){
        var scrollTarget=$(this).data("target");
        $('html,body').animate({
          scrollTop: $(scrollTarget).offset().top},'slow');
        });
  });


  // handle article voting. Events are registered in event-tracking.js
//  $("#did-this-help-no").off().on("click", function(){

    //Change Message
    //Report to Google

//  });

  // used by create topic form
  $('#topic_private_true').click(function(){
    $("#topic_forum_id").parent().hide();
    $('#new_topic').append("<input type='hidden' id='new_topic_forum_id' name='topic[forum_id]' value='1'/>")
  });
  $('#topic_private_false').click(function(){
    $("#topic_forum_id").parent().show();
    $("#new_topic_forum_id").remove();
  });

  // Hide/replace last child of breadcrumbs since I don't have time to hack gem right now
  $("ul.breadcrumb li:last-child").html("")


  // link entire row to child
  $('.link-row').mouseover(function(){
    $(this).css('cursor','pointer');
  });
  $('.link-row').mouseout(function(){
    $(this).css('cursor','auto');
  });
  $('.link-row').on('click', function(){
//  could be causing over tracking in GA?
//    document.location.href = $(this).find('a').attr('href');
  });

  // compress thread if there are more than 4 messages
  var $thread = $('.post-container.kind-reply, .post-container.kind-note')
  if ($thread.size() >= 2) {

    // insert expand thread message
//    var $hider = "<div class='collapsed-posts text-center'><span class='label label-collapsed'>" + ($thread.size()-1) + " collapsed messages </span></div>";
    var $hider = "<div class='collapsed-posts text-center'><span class='label label-collapsed'>" + Helpy.messages + " </span></div>";

    // check to see if we are already collapsed
    if ($(".collapsed-posts").size() == 0) {
      $(".kind-first").append($hider);
    }

    // add listener to expand messages
    $('.collapsed-posts').on('click', function(){
      $thread.show();
      $('.collapsed-posts').hide();
    });

    // hide thread, except for most recent message
    $thread.hide().last().show();
  }

  // Use common reply
  $('#post_reply_id').on('change', function(){
    $('#post_body').val($('#post_reply_id option:selected').val());
  });

  function updateMessage(){
    var output;
    var messages = $('.topic-checkbox:checked').size();

    switch(messages) {
      case 1:
        output = Helpy.selected[1];
        break;
      case 2:
        output = Helpy.selected[2];
        break;
      default:
        output = Helpy.selected[3].replace("9", messages);
        break;
    }
    $('.selected-message').text(output);
  };

  $('#check-all').off().on('change', function(){
    if (this.checked) {
      $('.topic-checkbox').prop('checked', true);
      $('#multiple-edit').show();
      updateMessage();

    } else {
      $('.topic-checkbox').prop('checked', false);
      $('#multiple-edit').fadeOut();
    }
  });

  $('.topic-checkbox').off().on('change', function(){

    if (this.checked) {
      $('#multiple-edit').show();
      updateMessage();

    } else {
      if ($('.topic-checkbox:checked').size() == 0) {
        $('#multiple-edit').fadeOut();
      } else {
        updateMessage();
      }
    }
  });

  $('.multiple-update').off().on('click', function(){
    // collect array of all checked boxes
    var topic_ids = {};
    var str = $(this).attr('href');
    $('.topic-checkbox:checked').each(function(i){
      topic_ids[i] = $(this).val();
    });
    // modify link to include array
    $.each(topic_ids, function(i){
      str = str + "&topic_ids[]=" + topic_ids[i]
    });
    $(this).attr('href', str);
    // return true to follow the link
    return true;
  });

  $('.post-container').off().on('mouseover', function(){
    var id = $(this).attr("id").split("-")[1];
    $(".post-menu-" + id).fadeIn();
  });

};

// This is included here because you would expect to find it here.  The function is actually called
// from event-tracking.js where we have to unbind and rebind the event to support turbolinks
Helpy.didthisHelp = function(yesno){
  var message;
  if (yesno == "no") {
    message = "<h3>We're sorry this did you help you.  Please open a discussion in our support forums for more help!</h3>";
  } else {
    message = "<h3>Great!! Thanks for the feedback!</h3>";
  }

  message = "<div class='col-md-12'>" + message + "</div>";

  $('#did-this-help').html(message);
  return true;
}

$(document).ready(Helpy.ready);
$(document).on('page:load', Helpy.ready);
